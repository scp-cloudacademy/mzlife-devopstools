---
# ArgoCD 2.14.16 Deployment for Kubernetes
# Namespace: devops-tool
# URL: https://DOMAIN_PLACEHOLDER/argocd
#
# Prerequisites:
#   1. Install CRDs first (required):
#      kubectl apply -f argocd-crd.yaml
#
#   2. Then deploy ArgoCD:
#      kubectl apply -f argocd-deploy.yaml
#
# Login Information:
#   URL: https://DOMAIN_PLACEHOLDER/argocd
#   ID: admin
#   PW: admin

---
# PersistentVolumeClaim for ArgoCD Redis
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: argocd-redis-pvc
  namespace: devops-tool
  labels:
    app: argocd-redis
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: nfs-subdir-external-sc
  resources:
    requests:
      storage: 5Gi

---
# PersistentVolumeClaim for ArgoCD Repo Server
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: argocd-repo-server-pvc
  namespace: devops-tool
  labels:
    app: argocd-repo-server
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: nfs-subdir-external-sc
  resources:
    requests:
      storage: 10Gi

---
# ConfigMap for ArgoCD Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: devops-tool
  labels:
    app.kubernetes.io/name: argocd-cm
    app.kubernetes.io/part-of: argocd
data:
  # Server URL configuration
  url: https://DOMAIN_PLACEHOLDER/argocd

  # Application controller settings
  application.instanceLabelKey: argocd.argoproj.io/instance

  # Resource tracking method (annotation-based is default in 2.14+)
  application.resourceTrackingMethod: annotation

  # Timeout settings
  timeout.reconciliation: 180s
  timeout.hard.reconciliation: 0s

  # Disable anonymous access
  users.anonymous.enabled: "false"

  # Admin user enabled
  admin.enabled: "true"

  # Exec feature (disabled for security)
  exec.enabled: "false"

  # Status badge enabled
  statusbadge.enabled: "true"

  # Kustomize build options
  kustomize.buildOptions: --load-restrictor LoadRestrictionsNone

---
# ConfigMap for ArgoCD Command Parameters
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: devops-tool
  labels:
    app.kubernetes.io/name: argocd-cmd-params-cm
    app.kubernetes.io/part-of: argocd
data:
  # Server configuration
  server.insecure: "true"
  server.basehref: /argocd
  server.rootpath: /argocd

  # Repo server parallelism
  reposerver.parallelism.limit: "0"

---
# ConfigMap for ArgoCD RBAC
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-rbac-cm
  namespace: devops-tool
  labels:
    app.kubernetes.io/name: argocd-rbac-cm
    app.kubernetes.io/part-of: argocd
data:
  policy.default: role:readonly
  policy.csv: |
    g, admin, role:admin

---
# Secret for ArgoCD with initial admin password
# Default password: ComplexPassword1!
# To generate new bcrypt hash:
#   htpasswd -nbBC 10 "" "YourPassword" | tr -d ':\n' | sed 's/$2y/$2a/'
apiVersion: v1
kind: Secret
metadata:
  name: argocd-secret
  namespace: devops-tool
  labels:
    app.kubernetes.io/name: argocd-secret
    app.kubernetes.io/part-of: argocd
type: Opaque
stringData:
  # bcrypt hash of "admin" - generated by ArgoCD CLI
  admin.password: "$2a$10$kOSXPZIwsQKGdscSwYCG0.KiSOiUQZSeOcZaK75FuV/xccPNoo33a"
  admin.passwordMtime: "2025-01-31T00:00:00Z"

---
# ServiceAccount for ArgoCD Server
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd

---
# ServiceAccount for ArgoCD Application Controller
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-application-controller
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-application-controller
    app.kubernetes.io/part-of: argocd

---
# ServiceAccount for ArgoCD Repo Server
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-repo-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: repo-server
    app.kubernetes.io/name: argocd-repo-server
    app.kubernetes.io/part-of: argocd

---
# ServiceAccount for ArgoCD Redis
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-redis
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: redis
    app.kubernetes.io/name: argocd-redis
    app.kubernetes.io/part-of: argocd

---
# ServiceAccount for ArgoCD Dex Server
apiVersion: v1
kind: ServiceAccount
metadata:
  name: argocd-dex-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: dex-server
    app.kubernetes.io/name: argocd-dex-server
    app.kubernetes.io/part-of: argocd

---
# ClusterRole for ArgoCD Server
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-server
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd
rules:
  - apiGroups:
      - "*"
    resources:
      - "*"
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
      - patch

---
# ClusterRole for ArgoCD Application Controller
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: argocd-application-controller
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-application-controller
    app.kubernetes.io/part-of: argocd
rules:
  - apiGroups:
      - "*"
    resources:
      - "*"
    verbs:
      - "*"
  - nonResourceURLs:
      - "*"
    verbs:
      - "*"

---
# ClusterRoleBinding for ArgoCD Server
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-server
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-server
subjects:
  - kind: ServiceAccount
    name: argocd-server
    namespace: devops-tool

---
# ClusterRoleBinding for ArgoCD Application Controller
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: argocd-application-controller
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-application-controller
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argocd-application-controller
subjects:
  - kind: ServiceAccount
    name: argocd-application-controller
    namespace: devops-tool

---
# Role for ArgoCD Server
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: argocd-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd
rules:
  - apiGroups:
      - ""
    resources:
      - secrets
      - configmaps
    verbs:
      - create
      - get
      - list
      - watch
      - update
      - patch
      - delete
  - apiGroups:
      - argoproj.io
    resources:
      - applications
      - appprojects
      - applicationsets
    verbs:
      - create
      - get
      - list
      - watch
      - update
      - delete
      - patch
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
      - list

---
# Role for ArgoCD Application Controller
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: argocd-application-controller
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-application-controller
    app.kubernetes.io/part-of: argocd
rules:
  - apiGroups:
      - ""
    resources:
      - secrets
      - configmaps
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - argoproj.io
    resources:
      - applications
      - appprojects
    verbs:
      - create
      - get
      - list
      - watch
      - update
      - patch
      - delete
  - apiGroups:
      - ""
    resources:
      - events
    verbs:
      - create
      - list

---
# Role for ArgoCD Dex Server
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: argocd-dex-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: dex-server
    app.kubernetes.io/name: argocd-dex-server
    app.kubernetes.io/part-of: argocd
rules:
  - apiGroups:
      - ""
    resources:
      - secrets
      - configmaps
    verbs:
      - get
      - list
      - watch

---
# RoleBinding for ArgoCD Server
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-server
subjects:
  - kind: ServiceAccount
    name: argocd-server
    namespace: devops-tool

---
# RoleBinding for ArgoCD Application Controller
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-application-controller
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-application-controller
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-application-controller
subjects:
  - kind: ServiceAccount
    name: argocd-application-controller
    namespace: devops-tool

---
# RoleBinding for ArgoCD Dex Server
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-dex-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: dex-server
    app.kubernetes.io/name: argocd-dex-server
    app.kubernetes.io/part-of: argocd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: argocd-dex-server
subjects:
  - kind: ServiceAccount
    name: argocd-dex-server
    namespace: devops-tool

---
# Redis Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-redis
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: redis
    app.kubernetes.io/name: argocd-redis
    app.kubernetes.io/part-of: argocd
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: argocd-redis
  template:
    metadata:
      labels:
        app.kubernetes.io/name: argocd-redis
    spec:
      serviceAccountName: argocd-redis
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        fsGroup: 999
      containers:
        - name: redis
          image: redis:7.2.4-alpine
          imagePullPolicy: IfNotPresent
          args:
            - --save
            - "60"
            - "1"
            - --loglevel
            - warning
          ports:
            - containerPort: 6379
              name: redis
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 256Mi
          volumeMounts:
            - name: redis-data
              mountPath: /data
      volumes:
        - name: redis-data
          persistentVolumeClaim:
            claimName: argocd-redis-pvc

---
# Redis Service
apiVersion: v1
kind: Service
metadata:
  name: argocd-redis
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: redis
    app.kubernetes.io/name: argocd-redis
    app.kubernetes.io/part-of: argocd
spec:
  ports:
    - name: tcp-redis
      port: 6379
      targetPort: 6379
  selector:
    app.kubernetes.io/name: argocd-redis

---
# Repo Server Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-repo-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: repo-server
    app.kubernetes.io/name: argocd-repo-server
    app.kubernetes.io/part-of: argocd
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: argocd-repo-server
  template:
    metadata:
      labels:
        app.kubernetes.io/name: argocd-repo-server
    spec:
      serviceAccountName: argocd-repo-server
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        fsGroup: 999
      containers:
        - name: argocd-repo-server
          image: quay.io/argoproj/argocd:v2.14.16
          imagePullPolicy: IfNotPresent
          command:
            - argocd-repo-server
          args:
            - --redis
            - argocd-redis:6379
          ports:
            - containerPort: 8081
              name: repo-server
            - containerPort: 8084
              name: metrics
          env:
            - name: ARGOCD_RECONCILIATION_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  key: timeout.reconciliation
                  name: argocd-cm
                  optional: true
            - name: ARGOCD_REPO_SERVER_LOGFORMAT
              valueFrom:
                configMapKeyRef:
                  key: reposerver.log.format
                  name: argocd-cmd-params-cm
                  optional: true
            - name: ARGOCD_REPO_SERVER_LOGLEVEL
              valueFrom:
                configMapKeyRef:
                  key: reposerver.log.level
                  name: argocd-cmd-params-cm
                  optional: true
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          readinessProbe:
            httpGet:
              path: /healthz?full=true
              port: 8084
            initialDelaySeconds: 30
            periodSeconds: 30
          livenessProbe:
            httpGet:
              path: /healthz?full=true
              port: 8084
            initialDelaySeconds: 30
            periodSeconds: 30
            failureThreshold: 3
          volumeMounts:
            - name: repo-server-tls
              mountPath: /app/config/reposerver/tls
            - name: tmp
              mountPath: /tmp
            - name: repo-data
              mountPath: /app/config/ssh
      volumes:
        - name: repo-server-tls
          emptyDir: {}
        - name: tmp
          emptyDir: {}
        - name: repo-data
          persistentVolumeClaim:
            claimName: argocd-repo-server-pvc

---
# Repo Server Service
apiVersion: v1
kind: Service
metadata:
  name: argocd-repo-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: repo-server
    app.kubernetes.io/name: argocd-repo-server
    app.kubernetes.io/part-of: argocd
spec:
  ports:
    - name: https-repo-server
      port: 8081
      targetPort: 8081
    - name: metrics
      port: 8084
      targetPort: 8084
  selector:
    app.kubernetes.io/name: argocd-repo-server

---
# Application Controller Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-application-controller
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-application-controller
    app.kubernetes.io/part-of: argocd
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: argocd-application-controller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: argocd-application-controller
    spec:
      serviceAccountName: argocd-application-controller
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        fsGroup: 999
      containers:
        - name: argocd-application-controller
          image: quay.io/argoproj/argocd:v2.14.16
          imagePullPolicy: IfNotPresent
          command:
            - argocd-application-controller
          args:
            - --redis
            - argocd-redis:6379
            - --repo-server
            - argocd-repo-server:8081
            - --status-processors
            - "20"
            - --operation-processors
            - "10"
          ports:
            - containerPort: 8082
              name: metrics
          env:
            - name: ARGOCD_RECONCILIATION_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  key: timeout.reconciliation
                  name: argocd-cm
                  optional: true
            - name: ARGOCD_APPLICATION_CONTROLLER_REPO_SERVER
              valueFrom:
                configMapKeyRef:
                  key: repo.server
                  name: argocd-cmd-params-cm
                  optional: true
            - name: ARGOCD_APPLICATION_CONTROLLER_SELF_HEAL_TIMEOUT_SECONDS
              valueFrom:
                configMapKeyRef:
                  key: controller.self.heal.timeout.seconds
                  name: argocd-cmd-params-cm
                  optional: true
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8082
            initialDelaySeconds: 30
            periodSeconds: 30
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8082
            initialDelaySeconds: 30
            periodSeconds: 30
            failureThreshold: 3

---
# Application Controller Service
apiVersion: v1
kind: Service
metadata:
  name: argocd-application-controller
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: application-controller
    app.kubernetes.io/name: argocd-application-controller
    app.kubernetes.io/part-of: argocd
spec:
  ports:
    - name: https-controller
      port: 8082
      targetPort: 8082
  selector:
    app.kubernetes.io/name: argocd-application-controller

---
# ArgoCD Server Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: argocd-server
  template:
    metadata:
      labels:
        app.kubernetes.io/name: argocd-server
    spec:
      serviceAccountName: argocd-server
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        fsGroup: 999
      containers:
        - name: argocd-server
          image: quay.io/argoproj/argocd:v2.14.16
          imagePullPolicy: IfNotPresent
          command:
            - argocd-server
          args:
            - --insecure
            - --basehref
            - /argocd
            - --rootpath
            - /argocd
            - --redis
            - argocd-redis:6379
            - --repo-server
            - argocd-repo-server:8081
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 8083
              name: metrics
          env:
            - name: ARGOCD_SERVER_INSECURE
              valueFrom:
                configMapKeyRef:
                  key: server.insecure
                  name: argocd-cmd-params-cm
                  optional: true
            - name: ARGOCD_SERVER_BASEHREF
              valueFrom:
                configMapKeyRef:
                  key: server.basehref
                  name: argocd-cmd-params-cm
                  optional: true
            - name: ARGOCD_SERVER_ROOTPATH
              valueFrom:
                configMapKeyRef:
                  key: server.rootpath
                  name: argocd-cmd-params-cm
                  optional: true
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          readinessProbe:
            httpGet:
              path: /healthz?full=true
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30
          livenessProbe:
            httpGet:
              path: /healthz?full=true
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 30
            failureThreshold: 3
          volumeMounts:
            - name: ssh-known-hosts
              mountPath: /app/config/ssh
            - name: tls-certs
              mountPath: /app/config/tls
      volumes:
        - name: ssh-known-hosts
          emptyDir: {}
        - name: tls-certs
          emptyDir: {}

---
# ArgoCD Server Service
apiVersion: v1
kind: Service
metadata:
  name: argocd-server
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
    - name: https
      port: 443
      targetPort: 8080
      protocol: TCP
    - name: metrics
      port: 8083
      targetPort: 8083
      protocol: TCP
  selector:
    app.kubernetes.io/name: argocd-server

---
# ArgoCD Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: argocd-ingress
  namespace: devops-tool
  labels:
    app.kubernetes.io/component: server
    app.kubernetes.io/name: argocd-server
    app.kubernetes.io/part-of: argocd
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/ssl-passthrough: "false"
spec:
  ingressClassName: nginx
  rules:
    - host: DOMAIN_PLACEHOLDER
      http:
        paths:
          - path: /argocd
            pathType: Prefix
            backend:
              service:
                name: argocd-server
                port:
                  number: 80
